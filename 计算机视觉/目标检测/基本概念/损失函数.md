---
title: 损失函数
created: 2025-12-26 15:25:52
updated: 2026-01-16 22:43:55
---
## 组成

- [[#Bounding Box 定位损失]]
- [[#分类损失]]

---
## Bounding Box 定位损失
### 基础

| 符号          | 含义    |
| ----------- | ----- |
| $x$         | 模型预测值 |
| $y$         | 真实值   |
| $z = x - y$ | 差异    |

---
#### L1 Loss

##### 公式
$$
L_{L_1}(x, y) = |x - y| = |z|
$$
##### 梯度
$$
\frac{\partial L_{L_1}(x, y)}{\partial z} = 
\begin{cases}
1, & \text{if }z \geq 1 \\
-1, & \text{otherwise}
\end{cases}
$$
**导数为常数：** 训练后期$z$很小时，若$lr$不变，损失函数很难继续收敛到更高的精度

---

#### L2 Loss
##### 公式
$$
L_{L_2}(x,y) = \frac{1}{2}(x - y)^2 = \frac{1}{2}z^2
$$
##### 梯度

$$
\frac{\partial L_{L_2}(x, y)}{\partial z} = z
$$
**导数为$z$：** 训练前期$z$很大时，导数也很大，训练初期不稳定

---
#### Smooth L1 Loss

最初在Fast RCNN论文中被提出

##### 公式
$$
L_{SmoothL_1}(x,y) = 
\begin{cases}
0.5(x-y)^2 = 0.5z^2, & \text{if }|x-y| < 1 \\
|x-y|-0.5 = |z|-0.5, & \text{otherwise}
\end {cases}
$$
##### 梯度
$$
\frac{\partial L_{SmoothL_1}(x, y)}{\partial z} = 
\begin{cases}
z, & \text{if }|x - y| < 1 \\ 
\pm1 , & \text{otherwise}
\end{cases}
$$
---
### 目标检测框回归损失（不计算IoU）
#### 公式

$$
L_{loc(t,v)} = \sum_{i \in (x,y,w,h)}L_{smoothL_1}(t_i - v_i) 
$$

其中

- $v = (v_x,\: v_y,\: v_w,\: v_h)$：`gt_bbox`，即真实框位置参数
- $t = (t_x,\:t_y,\:t_w,\:t_h)$ ：`predict_bbox`，即预测框的位置参数
即分别求x,y,w,h的loss，然后相加
#### 缺点
- 公式基于x,y,w,h相互独立的前提，但这四个参数实际上有一定相关性
- 使用smooth L1来计算损失和优化模型，但使用IoU评估模型，会导致优化和评估的目标不一致，最好也使用IoU来计算损失
___
### **IoU Loss**
#### 公式
$$
L_{IoU} = -ln^{IoU}
$$

$IoU$范围为$[0,1]$ ，故取负对数可以其接近1时损失接近0

#### 梯度
$$
\frac{\partial L_{IoU}} {\partial IoU} = -\frac{1}{IoU}
$$
**训练初期IoU为0时（真实框与预测框不相交），损失函数不可导，无法优化**
___
### **GIoU Loss**
#### **GIoU**

即**General IoU** [[损失函数.graph#^ZWqhvpZN|GIoU]]

$$
GIoU = IoU - \frac{|C - (A \cup B)|} {|C|}
$$
- 预测非常准确时（A，B重合），$IoU \to 1$，$\frac{|C - (A \cup B)|} {|C|} \to 0$，$GIoU \to 1$
- 预测非常不准确时（A，B不相交且距离无穷远），$IoU = 0$，$\frac{|C - (A \cup B)|} {|C|} = 1$，$GIoU = -1$
#### 公式
$$
L_{GIoU} = 1 - GIoU = 1 - IoU + \frac{|C - (A \cup B)|} {|C|}
$$
### **DIoU Loss**
#### **DIoU**

即**Distance IoU** [[损失函数.graph#^F2ISYKia|DIoU]]

- **$d$：预测框与真实框的中心点欧氏距离**
- **$c$：外接矩形的对角线长度**
$$
DIoU = IoU - \frac{d^2}{c^2}
$$
#### 公式
$$
L_{DIoU} = 1 - DIoU = 1 - IoU + \frac{d^2}{c^2}
$$

### **CIoU Loss**
#### **CIoU**
$$
CIoU = DIoU - \alpha v = IoU - \frac{d^2}{c^2} - \alpha v
$$
- $\alpha$：权重参数
$$
\alpha = \frac{v}{(1 - IoU) + v}
$$
	**$IoU$越大，$\alpha$越大，表示优先考虑高宽比**
	**$IoU$越小，$\alpha$越小，表示优先考虑距离比**

- $v$：衡量真实框和预测框**高宽比一致性**的参数
$$
v = \frac{4}{\pi^2} (arctan\frac{w_{gt}}{h_{gt}} - arctan\frac{w}{h})^2
$$
#### 公式
$$
L_{CIoU} = 1 - CIoU = 1 - IoU + \frac{d^2}{c^2} + \alpha v 
$$

## 分类损失
